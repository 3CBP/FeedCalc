<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultimate Dairy TMR Pro</title>
  <style>
    :root { --blue:#1565c0; --dark:#0d47a1; --accent:#ff9800; --red:#d32f2f; --green:#4caf50; }
    body { font-family:-apple-system,sans-serif; background:var(--blue); color:white; margin:0; padding:0; transition:0.3s; }
    body.dark { background:#000; color:#fff; }
    header { background:var(--dark); padding:20px; text-align:center; font-size:28px; font-weight:900; display:flex; align-items:center; justify-content:center; gap:15px; }
    .logo { width:60px; height:60px; border-radius:50%; border:3px solid white; }
    .tabs { display:flex; background:#1976d2; position:sticky; top:0; z-index:100; }
    .tab { flex:1; padding:18px; text-align:center; cursor:pointer; font-weight:bold; font-size:18px; }
    .tab.active { background:white; color:var(--dark); border-bottom:6px solid var(--accent); }
    .content { padding:20px; display:none; }
    .content.active { display:block; }
    input, select, button { width:100%; padding:16px; margin:12px 0; border:none; border-radius:10px; font-size:18px; }
    button { font-weight:900; cursor:pointer; }
    .calc { background:var(--accent); color:black; }
    .add { background:var(--green); }
    .del { background:var(--red); font-size:16px; padding:12px; width:auto; }
    .print { background:#2196f3; }
    .darkmode { background:#333; }
    .row { display:flex; gap:15px; align-items:center; margin:15px 0; background:rgba(255,255,255,.12); padding:15px; border-radius:12px; }
    .row span { flex:1; font-weight:bold; font-size:18px; }
    .row input[type=number] { width:120px; text-align:center; font-size:18px; }
    .feedsheet { background:white; color:black; padding:40px; border-radius:20px; margin:30px 0; border:8px solid var(--accent); box-shadow:0 20px 50px rgba(0,0,0,.7); }
    .feedsheet h2 { margin:0 0 30px; color:var(--dark); font-size:44px; text-align:center; }
    .loadline { display:flex; justify-content:space-between; padding:20px 0; border-bottom:4px dashed #555; font-size:38px; font-weight:900; }
    .cumulative { font-size:42px; color:var(--green); text-align:right; margin:25px 0; font-weight:900; }
    .totals { background:#f0f0f0; padding:35px; border-radius:16px; margin-top:40px; font-size:32px; font-weight:bold; }
    .big { font-size:60px; color:var(--accent); }
    .ready { background:#d32f2f; color:white; padding:30px; font-size:44px; text-align:center; border-radius:16px; animation:glow 1.5s infinite; }
    .qr { text-align:center; margin:30px 0; }
    @keyframes glow { 0%,100%{ box-shadow:0 0 30px #f00; } 50%{ box-shadow:0 0 60px #f00; } }
    @media print { body{background:white;color:black} .no-print{display:none} .feedsheet{border:4px solid #000;box-shadow:none} }
  </style>
</head>
<body>
  <header>
    <img src="logo.jpg" alt="Farm Logo" class="logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMjgiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2ZmOTgwMCIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiI8L3N2Zz4K';">
    ULTIMATE DAIRY TMR PRO
  </header>

  <div class="tabs no-print">
    <div class="tab active" data-tab="calc">Calculator</div>
    <div class="tab" data-tab="groups">Groups</div>
    <div class="tab" data-tab="feeds">Ingredients</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <div id="calc" class="content active">
    <select id="groupSelect"></select>
    <select id="rationSelect"></select>
    <button class="add" onclick="addRation()">+ New Ration</button>
    <input type="number" id="cows" placeholder="Number of cows" value="100">
    <input type="number" id="batches" placeholder="Batches today" value="1">
    <div style="display:flex;gap:30px;justify-content:center;margin:20px 0">
      <label><input type="radio" name="mode" value="percow" checked> Per cow</label>
      <label><input type="radio" name="mode" value="total"> Total herd</label>
    </div>
    <div id="inputs"></div>
    <button class="calc" onclick="calculate()">GENERATE FEED SHEET</button>
    <button class="print" onclick="window.print()">PRINT SHEET</button>
    <button class="darkmode" onclick="document.body.classList.toggle('dark')">DARK MODE</button>
    <div id="result"></div>
  </div>

  <div id="groups" class="content">
    <input type="text" id="newgroup" placeholder="New group name">
    <button class="add" onclick="addGroup()">Add Group</button>
    <div id="grouplist"></div>
  </div>

  <div id="feeds" class="content">
    <button class="add" onclick="addFeed()">+ Add Ingredient</button>
    <div style="margin:25px 0;font-size:18px">Drag to set loading order:</div>
    <div id="feedlist"></div>
  </div>

  <div id="settings" class="content">
    <h3>Settings</h3>
    <button class="del" onclick="if(confirm('ERASE ALL DATA?')){localStorage.clear();location.reload()}">RESET EVERYTHING</button>
    <p style="font-size:24px;margin-top:30px">Batches today: <span id="batchCount">0</span></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
  <script>
    let data = {groups:[], feeds:[], settings:{batchCount:0}};
    const defaults = {
      feeds: [
        {id:1,name:"Corn Silage",dm:35,nel:0.74,cp:8.5,ndf:42,price:48},
        {id:2,name:"Alfalfa Haylage",dm:40,nel:0.68,cp:20,ndf:44,price:180},
        {id:3,name:"Dairy Pellet",dm:89,nel:0.84,cp:19,ndf:22,price:340},
        {id:4,name:"Distillers Wet",dm:32,nel:0.92,cp:30,ndf:38,price:135},
        {id:5,name:"Cottonseed",dm:92,nel:0.98,cp:24,ndf:50,price:380}
      ],
      groups: [
        {id:1,name:"High Group",rations:[{id:1,name:"Standard",lbs:[24,12,8,6,2]}]},
        {id:2,name:"Fresh Cows",rations:[{id:2,name:"Fresh Pen",lbs:[18,15,10,8,3]}]}
      ]
    };

    try { data = JSON.parse(localStorage.getItem('dairyTMR') || JSON.stringify(defaults)); }
    catch(e) { data = defaults; }

    function save() { localStorage.setItem('dairyTMR', JSON.stringify(data)); }

    // TAB SYSTEM — BULLETPROOF
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        if(tab.dataset.tab === 'calc') renderCalc();
        if(tab.dataset.tab === 'groups') renderGroups();
        if(tab.dataset.tab === 'feeds') renderFeeds();
        if(tab.dataset.tab === 'settings') document.getElementById('batchCount').innerText = data.settings.batchCount;
      });
    });

    function renderCalc() {
      const groupSelect = document.getElementById('groupSelect');
      groupSelect.innerHTML = data.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
      updateRationSelect();
      updateInputs();
    }

    function updateRationSelect() {
      const gid = document.getElementById('groupSelect').value;
      const group = data.groups.find(g => g.id == gid);
      const rationSelect = document.getElementById('rationSelect');
      rationSelect.innerHTML = group.rations.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      updateInputs();
    }

    function updateInputs() {
      const gid = document.getElementById('groupSelect').value;
      const rid = document.getElementById('rationSelect').value;
      const ration = data.groups.find(g => g.id == gid)?.rations.find(r => r.id == rid);
      if (!ration) return;
      const html = data.feeds.map((f, i) => `
        <div class="row">
          <span>${f.name}</span>
          <input type="number" id="lb${i}" value="${ration.lbs[i] || 0}" step="0.1">
          <span>lb</span>
        </div>`).join('');
      document.getElementById('inputs').innerHTML = html;
    }

    function addRation() {
      const name = prompt("Ration name:");
      if (!name) return;
      const gid = document.getElementById('groupSelect').value;
      const group = data.groups.find(g => g.id == gid);
      const newRation = {id: Date.now(), name, lbs: new Array(data.feeds.length).fill(0)};
      group.rations.push(newRation);
      save();
      updateRationSelect();
      document.getElementById('rationSelect').value = newRation.id;
      updateInputs();
    }

    function calculate() {
      const gid = document.getElementById('groupSelect').value;
      const rid = document.getElementById('rationSelect').value;
      const cows = parseFloat(document.getElementById('cows').value) || 1;
      const batches = parseFloat(document.getElementById('batches').value) || 1;
      const perCow = document.querySelector('input[name="mode"]:checked').value === 'percow';
      const group = data.groups.find(g => g.id == gid);
      const ration = group.rations.find(r => r.id == rid);

      // Save current inputs
      data.feeds.forEach((f, i) => { ration.lbs[i] = parseFloat(document.getElementById(`lb${i}`).value) || 0; });
      save();

      // Increment batch
      data.settings.batchCount++;
      save();
      document.getElementById('batchCount').innerText = data.settings.batchCount;

      let total = 0, dmTotal = 0, nelW = 0, cpW = 0, ndfW = 0, costW = 0, cumulative = 0;
      let lines = '';

      const multiplier = (perCow ? 1 : cows) * batches;
      const items = data.feeds.map((f, i) => ({f, lb: ration.lbs[i] * multiplier}))
        .filter(x => x.lb > 0);

      items.forEach(item => {
        cumulative += item.lb;
        const dmLb = item.lb * (item.f.dm / 100);
        lines += `<div class="loadline"><div><strong>${item.f.name}</strong></div><div><span class="big">${item.lb.toFixed(0)}</span> lb</div></div>
                  <div class="cumulative">CUMULATIVE: ${cumulative.toFixed(0)} lb</div>`;
        dmTotal += dmLb;
        nelW += dmLb * item.f.nel;
        cpW += dmLb * (item.f.cp / 100);
        ndfW += dmLb * (item.f.ndf / 100);
        costW += item.lb * (item.f.price / 2000);
      });

      const nel = nelW / dmTotal;
      const cp = (cpW / dmTotal) * 100;
      const ndf = (ndfW / dmTotal) * 100;
      const dmi = dmTotal / cows / batches;

      const qr = document.createElement('div');
      new QRCode(qr, {text: location.href, width: 220, height: 220});

      document.getElementById('result').innerHTML = `
        <div class="ready">BATCH #${data.settings.batchCount} READY!</div>
        <div class="feedsheet">
          <h2>${group.name} - ${ration.name}</h2>
          <div style="text-align:center;font-size:36px">${cows * batches} COWS • ${batches} BATCH${batches>1?'ES':''}<br>DM: ${dmi.toFixed(1)} lb/cow</div>
          ${lines}
          <div class="totals">
            <div>TOTAL: <span class="big">${cumulative.toFixed(0)}</span> lb</div>
            <div>NEₗ ${nel.toFixed(3)} • CP ${cp.toFixed(1)}% • NDF ${ndf.toFixed(1)}%</div>
            <div>COST $<span class="big">${costW.toFixed(0)}</span> (${(costW/(cows*batches)).toFixed(2)}/cow)</div>
          </div>
          <div class="qr">${qr.innerHTML}</div>
        </div>`;
    }

    function renderGroups() {
      document.getElementById('grouplist').innerHTML = data.groups.map(g => `
        <div style="margin:25px 0;background:rgba(255,255,255,.1);padding:20px;border-radius:14px">
          <div class="row"><input value="${g.name}" onchange="renameGroup(${g.id},this.value)">
            <button class="del" onclick="deleteGroup(${g.id})">Delete</button>
          </div>
          ${g.rations.map(r => `<div class="row" style="margin-left:30px"><input value="${r.name}" onchange="renameRation(${g.id},${r.id},this.value)">
            <button class="del" onclick="deleteRation(${g.id},${r.id})">Delete</button></div>`).join('')}
        </div>`).join('');
    }

    function renameGroup(id, v) { data.groups.find(g => g.id == id).name = v; save(); renderCalc(); }
    function renameRation(gid, rid, v) { data.groups.find(g => g.id == gid).rations.find(r => r.id == rid).name = v; save(); renderCalc(); }
    function deleteGroup(id) { if(confirm('Delete group?')) { data.groups = data.groups.filter(g => g.id != id); save(); renderGroups(); renderCalc(); }}
    function deleteRation(gid, rid) { if(confirm('Delete ration?')) { data.groups.find(g => g.id == gid).rations = data.groups.find(g => g.id == gid).rations.filter(r => r.id != rid); save(); renderGroups(); renderCalc(); }}
    function addGroup() { const name = prompt("Group name:") || "New Group"; data.groups.push({id:Date.now(), name, rations:[]}); save(); renderGroups(); renderCalc(); }

    function renderFeeds() {
      const list = document.getElementById('feedlist');
      list.innerHTML = data.feeds.map(f => `
        <div class="row" data-id="${f.id}" style="cursor:move">
          <input value="${f.name}" onchange="editFeed(${f.id},'name',this.value)" style="font-weight:bold">
          <input type="number" value="${f.dm}" step="0.1" onchange="editFeed(${f.id},'dm',this.value)"> DM%
          <input type="number" value="${f.nel}" step="0.001" onchange="editFeed(${f.id},'nel',this.value)"> NEₗ
          <input type="number" value="${f.cp}" step="0.1" onchange="editFeed(${f.id},'cp',this.value)"> CP%
          <input type="number" value="${f.ndf}" step="0.1" onchange="editFeed(${f.id},'ndf',this.value)"> NDF%
          <input type="number" value="${f.price}" step="1" onchange="editFeed(${f.id},'price',this.value)"> $/ton
          <button class="del" onclick="deleteFeed(${f.id})">Delete</button>
        </div>`).join('');
      new Sortable(list, {animation:150, onEnd:()=>{ data.feeds = Array.from(list.children).map(el => data.feeds.find(f => f.id == el.dataset.id)); save(); }});
    }

    function editFeed(id, field, value) {
      const feed = data.feeds.find(f => f.id == id);
      feed[field] = field === 'name' ? value : parseFloat(value) || 0;
      save();
    }

    function addFeed() {
      const name = prompt("Ingredient name:");
      if (!name) return;
      data.feeds.push({id:Date.now(), name, dm:88, nel:0.80, cp:18, ndf:25, price:300});
      data.groups.forEach(g => g.rations.forEach(r => r.lbs.push(0)));
      save(); renderFeeds(); renderCalc();
    }

    function deleteFeed(id) {
      if (!confirm("Delete from ALL rations?")) return;
      const index = data.feeds.findIndex(f => f.id == id);
      data.feeds.splice(index, 1);
      data.groups.forEach(g => g.rations.forEach(r => r.lbs.splice(index, 1)));
      save(); renderFeeds(); renderCalc();
    }

    // EVENT LISTENERS
    document.getElementById('groupSelect').onchange = () => { updateRationSelect(); updateInputs(); };
    document.getElementById('rationSelect').onchange = updateInputs;

    // INITIALIZE
    renderCalc();
    renderGroups();
    renderFeeds();
  </script>
</body>
</html>