<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minimal Feed Ration Calculator</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 1em; }
    input, button { margin: 0.3em 0; padding: 0.5em; width: 100%; }
    .section { margin: 1em 0; border: 1px solid #ccc; padding: 1em; border-radius: 6px; }
    .output { white-space: pre-line; font-weight: bold; margin-top: 1em; }
  </style>
</head>
<body>
  <h2>Feed Ration Calculator</h2>

  <input type="text" id="rationName" placeholder="📝 Ration name">
  <button onclick="createRation()">➕ Create Ration</button>
  <select id="savedRations" onchange="loadRation(this.value)">
    <option value="">— Load Saved Ration —</option>
  </select>

  <div id="rationArea"></div>

  <script>
    function createRation() {
      const name = document.getElementById("rationName").value.trim();
      if (!name) return alert("Enter ration name.");

      const area = document.getElementById("rationArea");
      area.innerHTML = `
        <div class="section">
          <h3>${name}</h3>
          <div id="groups"></div>
          <button onclick="addGroup()">Add Group</button>
          <div id="ingredients"></div>
          <button onclick="addIngredient()">Add Ingredient</button>
          <button onclick="saveRation('${name}')">💾 Save</button>
          <div class="output" id="results"></div>
        </div>
      `;
    }

    function addGroup() {
      const container = document.getElementById("groups");
      const div = document.createElement("div");
      div.innerHTML = `
        <input type="text" placeholder="Group name" class="groupName">
        <input type="number" placeholder="Number of cows" class="cowCount" oninput="updateTotals()">
      `;
      container.appendChild(div);
    }

    function addIngredient() {
      const container = document.getElementById("ingredients");
      const div = document.createElement("div");
      div.innerHTML = `
        <input type="text" placeholder="Ingredient name" class="ingName">
        <input type="number" placeholder="Lbs per cow/day" class="ingAmount" oninput="updateTotals()">
      `;
      container.appendChild(div);
    }

    function updateTotals() {
      const cowCounts = document.querySelectorAll(".cowCount");
      const ingredients = document.querySelectorAll(".ingName");
      const amounts = document.querySelectorAll(".ingAmount");
      const results = document.getElementById("results");

      let groups = [], totalCows = 0;
      cowCounts.forEach((el, i) => {
        const name = document.querySelectorAll(".groupName")[i].value || `Group ${i+1}`;
        const cows = parseFloat(el.value);
        if (!isNaN(cows)) {
          groups.push({ name, cows });
          totalCows += cows;
        }
      });

      let feedSummary = `Total Cows: ${totalCows}\n\nIngredient Totals:\n`;
      let breakdown = `\nGroup Breakdown:\n`;

      for (let i = 0; i < ingredients.length; i++) {
        const name = ingredients[i].value || `Ingredient ${i+1}`;
        const lbs = parseFloat(amounts[i].value);
        if (isNaN(lbs)) continue;

        let total = 0;
        groups.forEach(group => { total += group.cows * lbs; });
        feedSummary += `  ${name}: ${total.toFixed(2)} lbs\n`;

        groups.forEach(group => {
          const groupTotal = group.cows * lbs;
          breakdown += `  ${group.name} - ${name}: ${groupTotal.toFixed(2)} lbs\n`;
        });
      }

      results.textContent = feedSummary + breakdown;
    }

    function saveRation(name) {
      const groupData = [];
      const ingredientData = [];

      document.querySelectorAll(".groupName").forEach((el, i) => {
        groupData.push({
          name: el.value,
          cows: document.querySelectorAll(".cowCount")[i].value
        });
      });

      document.querySelectorAll(".ingName").forEach((el, i) => {
        ingredientData.push({
          name: el.value,
          pounds: document.querySelectorAll(".ingAmount")[i].value
        });
      });

      localStorage.setItem("ration_" + name, JSON.stringify({ groupData, ingredientData }));
      alert("Saved!");
      updateSavedRationList();
    }

    function updateSavedRationList() {
      const select = document.getElementById("savedRations");
      select.innerHTML = '<option value="">— Load Saved Ration —</option>';
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith("ration_")) {
          const name = key.replace("ration_", "");
          select.innerHTML += `<option value="${name}">${name}</option>`;
        }
      });
    }

    function loadRation(name) {
      const stored = localStorage.getItem("ration_" + name);
      if (!stored) return;
      const data = JSON.parse(stored);
      document.getElementById("rationName").value = name;
      createRation();

      const groupContainer = document.getElementById("groups");
      data.groupData.forEach(g => {
        const div = document.createElement("div");
        div.innerHTML = `<input type="text" class="groupName" value="${g.name}">
                         <input type="number" class="cowCount" value="${g.cows}" oninput="updateTotals()">`;
        groupContainer.appendChild(div);
      });

      const ingContainer = document.getElementById("ingredients");
      data.ingredientData.forEach(i => {
        const div = document.createElement("div");
        div.innerHTML = `<input type="text" class="ingName" value="${i.name}">
                         <input type="number" class="ingAmount" value="${i.pounds}" oninput="updateTotals()">`;
        ingContainer.appendChild(div);
      });

      updateTotals();
    }

    updateSavedRationList();
  </script>
</body>
</html>
