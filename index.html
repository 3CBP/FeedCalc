<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultimate Dairy TMR Pro</title>
  <style>
    :root { --blue: #1565c0; --dark: #0d47a1; --accent: #ff9800; --red: #d32f2f; --green: #4caf50; }
    body { font-family: -apple-system, sans-serif; background: var(--blue); color: white; margin: 0; padding: 0; transition: all 0.3s; }
    body.dark { background: #121212; color: #eee; }
    header { background: var(--dark); padding: 20px; text-align: center; font-size: 24px; font-weight: bold; }
    .tabs { display: flex; background: #1976d2; }
    .tab { flex: 1; padding: 16px; text-align: center; cursor: pointer; font-weight: bold; }
    .tab.active { background: white; color: var(--dark); border-bottom: 4px solid var(--accent); }
    .content { padding: 20px; display: none; }
    .content.active { display: block; }
    input, select { width: 100%; padding: 14px; margin: 10px 0; border: none; border-radius: 8px; font-size: 17px; background: rgba(255,255,255,0.95); color: #000; }
    button { width: 100%; padding: 16px; margin: 12px 0; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .calc { background: var(--accent); color: black; }
    .add { background: #4caf50; color: white; }
    .del { background: var(--red); color: white; font-size: 14px; padding: 10px; width: auto; }
    .print { background: #2196f3; color: white; }
    .darkmode { background: #333; color: white; }
    .row { display: flex; align-items: center; gap: 12px; margin: 12px 0; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; }
    .row span { flex: 1; font-weight: bold; }
    .row input[type=number] { width: 100px; text-align: center; }
    .feedsheet { background: white; color: black; padding: 30px; border-radius: 16px; margin-top: 20px; font-family: 'Courier New', monospace; line-height: 1.8; font-size: 24px; font-weight: bold; border: 6px solid var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .feedsheet h2 { font-size: 36px; text-align: center; margin-bottom: 20px; color: var(--dark); }
    .loadline { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 3px dashed #666; font-size: 32px; font-weight: 900; }
    .cumulative { font-size: 34px; color: var(--green); text-align: right; margin: 20px 0; font-weight: 900; }
    .totals { background: #f0f0f0; padding: 20px; border-radius: 12px; margin-top: 30px; font-size: 28px; font-weight: bold; }
    .big { font-size: 48px; color: var(--accent); }
    .ready { background: #d32f2f; color: white; padding: 20px; font-size: 32px; text-align: center; border-radius: 12px; animation: flash 1s infinite; }
    .qr { text-align: center; margin: 20px 0; }
    @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    @media print { body { background: white; color: black; } .no-print { display: none; } .feedsheet { border: none; box-shadow: none; } }
  </style>
</head>
<body>
  <header>Ultimate Dairy TMR Pro</header>
  
  <div class="tabs no-print">
    <div class="tab active" onclick="tab('calc')">Calculator</div>
    <div class="tab" onclick="tab('groups')">Groups</div>
    <div class="tab" onclick="tab('feeds')">Ingredients</div>
  </div>

  <div id="calc" class="content active">
    <select id="groupSelect"></select>
    <select id="rationSelect"></select>
    <button class="add" onclick="addRationToGroup()">+ New Ration</button>
    <input type="number" id="cows" placeholder="Number of cows" value="100">
    <div style="display:flex;gap:10px">
      <label><input type="radio" name="mode" value="percow" checked> Per cow</label>
      <label><input type="radio" name="mode" value="total"> Total herd</label>
    </div>
    <div id="inputs"></div>
    <button class="calc" onclick="calc()">Generate Feed Sheet</button>
    <button class="print" onclick="window.print()">Print Sheet</button>
    <button class="darkmode" onclick="toggleDarkMode()">Dark Mode</button>
    <div id="result" class="result"></div>
  </div>

  <div id="groups" class="content">
    <input type="text" id="newgroup" placeholder="New group name">
    <button class="add" onclick="addGroup()">Add Group</button>
    <div id="grouplist"></div>
  </div>

  <div id="feeds" class="content">
    <button class="add" onclick="addIngredient()">+ Add Ingredient</button>
    <div style="margin:20px 0">Drag to reorder load sequence:</div>
    <div id="feedlist"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    let data = {groups: [], feeds: []};
    const defaults = {
      feeds: [
        {id: 1, name: "Corn Silage", dm: 35, nel: 0.74, cp: 8.5, ndf: 42, price: 48},
        {id: 2, name: "Alfalfa Haylage", dm: 40, nel: 0.68, cp: 20, ndf: 44, price: 180},
        {id: 3, name: "Dairy Pellet 18%", dm: 89, nel: 0.84, cp: 19, ndf: 22, price: 340},
        {id: 4, name: "Distillers Grains", dm: 32, nel: 0.92, cp: 30, ndf: 38, price: 135},
        {id: 5, name: "Whole Cottonseed", dm: 92, nel: 0.98, cp: 24, ndf: 50, price: 380}
      ],
      groups: [
        {id: 1, name: "High Milk Cows", rations: [
          {id: 1, name: "Summer Ration", lbs: [24, 12, 8, 6, 2]},
          {id: 2, name: "Winter Ration", lbs: [20, 15, 10, 5, 1]}
        ]},
        {id: 2, name: "Fresh Cows", rations: [
          {id: 3, name: "Week 1 Ration", lbs: [18, 14, 12, 8, 3]}
        ]}
      ]
    };

    try { data = JSON.parse(localStorage.getItem('dairyData') || JSON.stringify(defaults)); } catch(e) { data = defaults; }

    function save() {
      localStorage.setItem('dairyData', JSON.stringify(data));
    }

    function tab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[onclick="tab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'calc') renderCalc();
      if (tabId === 'groups') renderGroups();
      if (tabId === 'feeds') renderFeeds();
    }

    function renderCalc() {
      document.getElementById('groupSelect').innerHTML = data.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
      updateRationSelect();
      updateInputs();
    }

    function updateRationSelect() {
      const gid = document.getElementById('groupSelect').value;
      const group = data.groups.find(g => g.id == gid);
      document.getElementById('rationSelect').innerHTML = group.rations.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      updateInputs();
    }

    function updateInputs() {
      const gid = document.getElementById('groupSelect').value;
      const rid = document.getElementById('rationSelect').value;
      const group = data.groups.find(g => g.id == gid);
      const ration = group.rations.find(r => r.id == rid);
      let html = '';
      data.feeds.forEach((f, i) => {
        html += `<div class="row">
          <span>${f.name}</span>
          <input type="number" id="lb${i}" value="${ration.lbs[i] || 0}" step="0.1">
          <span>lb</span>
        </div>`;
      });
      document.getElementById('inputs').innerHTML = html;
    }

    function addRationToGroup() {
      const name = prompt("New ration name:");
      if (!name) return;
      const gid = document.getElementById('groupSelect').value;
      const group = data.groups.find(g => g.id == gid);
      group.rations.push({ id: Date.now(), name, lbs: new Array(data.feeds.length).fill(0) });
      save();
      updateRationSelect();
      document.getElementById('rationSelect').value = group.rations[group.rations.length - 1].id;
      updateInputs();
    }

    function calc() {
      const gid = document.getElementById('groupSelect').value;
      const rid = document.getElementById('rationSelect').value;
      const cows = parseFloat(document.getElementById('cows').value) || 1;
      const perCow = document.querySelector('input[name="mode"]:checked').value === 'percow';
      const group = data.groups.find(g => g.id == gid);
      const ration = group.rations.find(r => r.id == rid);

      data.feeds.forEach((f, i) => ration.lbs[i] = parseFloat(document.getElementById(`lb${i}`).value) || 0);
      save();

      let totalAsFed = 0, dmTotal = 0, nelW = 0, cpW = 0, ndfW = 0, costW = 0;
      let loadLines = '', cumulative = 0;

      const sorted = data.feeds.map((f, i) => ({f, i, lb: ration.lbs[i] * (perCow ? 1 : cows)}))
        .filter(x => x.lb > 0);

      sorted.forEach(item => {
        const lb = item.lb;
        cumulative += lb;
        const dmLb = lb * (item.f.dm / 100);
        loadLines += `<div class="loadline">
          <div><strong>${item.f.name}</strong></div>
          <div><span class="big">${lb.toFixed(1)}</span> lb</div>
        </div>
        <div class="cumulative">CUMULATIVE: ${cumulative.toFixed(1)} lb</div>`;

        dmTotal += dmLb;
        nelW += dmLb * item.f.nel;
        cpW += dmLb * (item.f.cp / 100);
        ndfW += dmLb * (item.f.ndf / 100);
        costW += lb * (item.f.price / 2000);
      });

      const nel = nelW / dmTotal;
      const cp = (cpW / dmTotal) * 100;
      const ndf = (ndfW / dmTotal) * 100;
      const dmi = dmTotal / cows;

      const qrDiv = document.createElement('div');
      new QRCode(qrDiv, { text: window.location.href, width: 200, height: 200 });

      document.getElementById('result').innerHTML = `
        <div class="ready">READY TO MIX!</div>
        <div class="feedsheet">
          <h2>${group.name} - ${ration.name}</h2>
          <div style="text-align:center;font-size:32px">
            ${perCow ? '1 COW' : cows + ' COWS'}<br>
            DM: ${dmi.toFixed(1)} lb/cow
          </div>
          ${loadLines}
          <div class="totals">
            <div>TOTAL BATCH: <span class="big">${totalAsFed = cumulative; cumulative.toFixed(1)}</span> lb</div>
            <div>NEₗ: ${nel.toFixed(3)} Mcal/lb</div>
            <div>CP: ${cp.toFixed(1)}% | NDF: ${ndf.toFixed(1)}%</div>
            <div>COST: <span class="big">$${costW.toFixed(0)}</span> (${(costW / cows).toFixed(2)}/cow)</div>
          </div>
          <div class="qr">${qrDiv.innerHTML}</div>
        </div>`;
    }

    function renderGroups() {
      let html = '';
      data.groups.forEach(g => {
        html += `<div style="margin:20px 0;background:rgba(255,255,255,0.1);padding:15px;border-radius:12px">
          <div class="row">
            <input value="${g.name}" onchange="data.groups.find(x=>x.id==${g.id}).name=this.value;save();renderCalc()">
            <button class="del" onclick="if(confirm('Delete group?')){data.groups=data.groups.filter(x=>x.id!=${g.id});save();renderGroups();renderCalc()}">Delete</button>
          </div>
          ${g.rations.map(r => `
            <div class="row" style="margin-left:20px">
              <input value="${r.name}" onchange="data.groups.find(x=>x.id==${g.id}).rations.find(y=>y.id==${r.id}).name=this.value;save();renderCalc()">
              <button class="del" onclick="if(confirm('Delete ration?')){data.groups.find(x=>x.id==${g.id}).rations=data.groups.find(x=>x.id==${g.id}).rations.filter(y=>y.id!=${r.id});save();renderGroups();renderCalc()}">Delete</button>
            </div>
          `).join('')}
        </div>`;
      });
      document.getElementById('grouplist').innerHTML = html;
    }

    function addGroup() {
      const name = prompt("Group name:") || "New Group";
      data.groups.push({id: Date.now(), name, rations: []});
      save(); renderGroups(); renderCalc();
    }

    function renderFeeds() {
      const list = document.getElementById('feedlist');
      list.innerHTML = data.feeds.map(f => `
        <div class="row" data-id="${f.id}" style="cursor:move">
          <input value="${f.name}" onchange="edit(${f.id},'name',this.value)" style="font-weight:bold">
          <input type="number" value="${f.dm}" step="0.1" onchange="edit(${f.id},'dm',this.value)"> DM%
          <input type="number" value="${f.nel}" step="0.001" onchange="edit(${f.id},'nel',this.value)"> NEₗ
          <input type="number" value="${f.cp}" step="0.1" onchange="edit(${f.id},'cp',this.value)"> CP%
          <input type="number" value="${f.ndf}" step="0.1" onchange="edit(${f.id},'ndf',this.value)"> NDF%
          <input type="number" value="${f.price}" step="1" onchange="edit(${f.id},'price',this.value)"> $/ton
          <button class="del" onclick="delFeed(${f.id})">Delete</button>
        </div>
      `).join('');
      new Sortable(list, {animation: 150, onEnd: () => {
        data.feeds = Array.from(list.children).map(el => data.feeds.find(f => f.id == el.dataset.id));
        save();
      }});
    }

    function edit(id, fld, val){
      const f = data.feeds.find(x => x.id == id);
      f[fld] = fld === 'name' ? val : parseFloat(val) || 0;
      save();
    }

    function addIngredient() {
      const name = prompt("Ingredient name:");
      if (!name) return;
      data.feeds.push({ id: Date.now(), name, dm: 88, nel: 0.80, cp: 18, ndf: 25, price: 300 });
      data.groups.forEach(g => g.rations.forEach(r => r.lbs.push(0)));
      save(); renderFeeds(); renderCalc();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    // INITIAL
    renderCalc();
  </script>
</body>
</html>