<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dairy TMR Calculator</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="logo.jpeg">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1565c0">
  <style>
    body{background:#1565c0;color:#fff;font-family:-apple-system,sans-serif;margin:0;padding:20px;}
    header{text-align:center;padding:20px;background:#0d47a1;margin:-20px -20px 30px;}
    .logo{width:80px;height:80px;border-radius:50%;border:4px solid #fff;}
    h1{margin:10px 0;font-size:28px;}
    .tabs{display:flex;gap:10px;margin-bottom:20px;}
    .tab{flex:1;padding:15px;background:rgba(255,255,255,.2);text-align:center;border-radius:8px;cursor:pointer;font-weight:bold;}
    .tab.active{background:#fff;color:#0d47a1;}
    .content{display:none;padding:10px;}
    .content.active{display:block;}
    input,select,button{width:100%;padding:12px;margin:8px 0;border:none;border-radius:8px;font-size:16px;}
    button{background:#ff9800;color:#000;font-weight:bold;cursor:pointer;}
    .add{background:#4caf50;}
    .del{background:#d32f2f;width:auto;padding:8px 16px;font-size:14px;}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0;background:rgba(255,255,255,.1);padding:12px;border-radius:8px;}
    .row span{flex:1;font-weight:bold;}
    .row input[type=number]{width:110px;text-align:center;}
    .result{margin-top:30px;}
    .feedsheet{background:#fff;color:#000;padding:40px;border-radius:20px;border:8px solid #ff9800;box-shadow:0 20px 40px rgba(0,0,0,.5);}
    .loadline{display:flex;justify-content:space-between;font-size:38px;font-weight:900;padding:15px 0;border-bottom:3px dashed #666;}
    .cumulative{font-size:42px;color:#4caf50;text-align:right;margin:20px 0;}
    .big{font-size:70px;color:#ff9800;}
    .ready{background:#d32f2f;color:#fff;padding:25px;font-size:40px;text-align:center;border-radius:15px;animation:glow 1.5s infinite;}
    @keyframes glow{0%,100%{box-shadow:0 0 30px #f00;}50%{box-shadow:0 0 60px #f00;}}
    @media print{.no-print{display:none}body{background:#fff;color:#000}.feedsheet{border:4px solid #000;}}
  </style>
</head>
<body>
<header>
  <img src="logo.jpeg" class="logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMzYiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2ZmOTgwMCIgc3Ryb2tlLXdpZHRoPSI4Ii8+CiI8L3N2Zz4K';">
  <h1>Dairy TMR Calculator</h1>
</header>

<div class="tabs no-print">
  <div class="tab active" onclick="openTab('calc')">Calculator</div>
  <div class="tab" onclick="openTab('groups')">Groups & Rations</div>
  <div class="tab" onclick="openTab('feeds')">Ingredients</div>
</div>

<!-- CALCULATOR TAB -->
<div id="calc" class="content active">
  <select id="groupSelect"></select>
  <select id="rationSelect"></select>
  <button class="add" onclick="addRation()" style="margin:10px 0;">+ Add New Ration</button>
  <input type="number" id="cows" placeholder="Number of cows" value="100">
  <div id="inputs"></div>
  <button onclick="calculate()" style="margin-top:20px;font-size:18px;">GENERATE BATCH SHEET</button>
  <button onclick="window.print()">PRINT SHEET</button>
  <div id="result" class="result"></div>
</div>

<!-- GROUPS & RATIONS TAB -->
<div id="groups" class="content">
  <input type="text" id="newGroupName" placeholder="New group name (e.g. High Group)">
  <button class="add" onclick="addGroup()">+ ADD GROUP</button>
  <div id="groupList" style="margin-top:20px;"></div>
</div>

<!-- INGREDIENTS TAB -->
<div id="feeds" class="content">
  <input type="text" id="newFeedName" placeholder="New ingredient (e.g. Corn Silage)">
  <button class="add" onclick="addFeed()">+ ADD INGREDIENT</button>
  <div id="feedList" style="margin-top:20px;"></div>
</div>

<script>
  let data = {
    feeds: [
      {id:1, name:"Corn Silage"},
      {id:2, name:"Alfalfa Haylage"},
      {id:3, name:"Dairy Pellet"}
    ],
    groups: [{
      id:1,
      name:"High Group",
      rations: [{
        id:1,
        name:"Standard",
        lbs:[2500,1200,800]
      }]
    }]
  };

  try {
    const saved = localStorage.getItem('dairyTMR_final');
    if (saved) data = JSON.parse(saved);
  } catch(e) {}

  function save() {
    localStorage.setItem('dairyTMR_final', JSON.stringify(data));
  }

  function openTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.querySelector(`[onclick="openTab('${tab}')"]`).classList.add('active');
    document.getElementById(tab).classList.add('active');
    if (tab === 'calc') renderCalc();
    if (tab === 'groups') renderGroups();
    if (tab === 'feeds') renderFeeds();
  }

  // === CALCULATOR ===
  function renderCalc() {
    const gSel = document.getElementById('groupSelect');
    gSel.innerHTML = data.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
    const group = data.groups.find(g => g.id == gSel.value);
    const rSel = document.getElementById('rationSelect');
    rSel.innerHTML = group.rations.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    renderInputs();

    gSel.onchange = () => {
      const grp = data.groups.find(g => g.id == gSel.value);
      rSel.innerHTML = grp.rations.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      renderInputs();
    };
    rSel.onchange = renderInputs;
  }

  function renderInputs() {
    const gid = document.getElementById('groupSelect').value;
    const rid = document.getElementById('rationSelect').value;
    const ration = data.groups.find(g => g.id == gid)?.rations.find(r => r.id == rid);
    if (!ration) return;

    document.getElementById('inputs').innerHTML = data.feeds.map((f, i) => `
      <div class="row">
        <span>${f.name}</span>
        <input type="number" id="lb${i}" value="${ration.lbs[i] || 0}" step="1">
        <span>lb total</span>
      </div>
    `).join('');
  }

  function addRation() {
    const gid = document.getElementById('groupSelect').value;
    const group = data.groups.find(g => g.id == gid);
    const name = prompt("New ration name:", "New Ration") || "New Ration";
    group.rations.push({
      id: Date.now(),
      name: name,
      lbs: new Array(data.feeds.length).fill(0)
    });
    save();
    renderCalc();
    document.getElementById('rationSelect').value = group.rations[group.rations.length-1].id;
    renderInputs();
  }

  function calculate() {
    const gid = document.getElementById('groupSelect').value;
    const rid = document.getElementById('rationSelect').value;
    const cows = parseFloat(document.getElementById('cows').value) || 100;
    const group = data.groups.find(g => g.id == gid);
    const ration = group.rations.find(r => r.id == rid);

    // Save current values
    data.feeds.forEach((f, i) => {
      ration.lbs[i] = parseFloat(document.getElementById(`lb${i}`).value) || 0;
    });
    save();

    let cumulative = 0;
    let lines = '';
    data.feeds.forEach((f, i) => {
      const lb = ration.lbs[i];
      if (lb > 0) {
        cumulative += lb;
        lines += `
          <div class="loadline"><div>${f.name}</div><div>${lb.toFixed(0)} lb</div></div>
          <div class="cumulative">CUMULATIVE: ${cumulative.toFixed(0)} lb</div>
        `;
      }
    });

    document.getElementById('result').innerHTML = `
      <div class="ready">BATCH READY!</div>
      <div class="feedsheet">
        <h2>${group.name} – ${ration.name}</h2>
        <div style="text-align:center;font-size:36px;margin:30px 0">${cows} COWS – TOTAL BATCH</div>
        ${lines}
        <div style="text-align:center;margin-top:40px">
          <span class="big">${cumulative.toFixed(0)}</span> lb TOTAL
        </div>
      </div>
    `;
  }

  // === GROUPS & RATIONS TAB ===
  function renderGroups() {
    document.getElementById('groupList').innerHTML = data.groups.map(g => `
      <div style="background:rgba(255,255,255,.1);margin:20px 0;padding:20px;border-radius:12px;">
        <div class="row">
          <input value="${g.name}" onchange="updateGroupName(${g.id}, this.value)" style="font-size:18px;font-weight:bold;">
          <button class="del" onclick="deleteGroup(${g.id})">Delete Group</button>
        </div>
        <div style="margin-top:10px;">
          ${g.rations.map(r => `
            <div class="row" style="margin:8px 0 8px 20px;background:rgba(255,255,255,.05);">
              <input value="${r.name}" onchange="updateRationName(${g.id},${r.id},this.value)">
              <button class="del" onclick="deleteRation(${g.id},${r.id})">Delete</button>
            </div>
          `).join('')}
          <button class="add" onclick="selectGroupAndAddRation(${g.id})" style="margin-top:10px;">+ Add Ration to ${g.name}</button>
        </div>
      </div>
    `).join('');
  }

  function addGroup() {
    const name = document.getElementById('newGroupName').value.trim();
    if (!name) return alert("Enter a group name");
    data.groups.push({
      id: Date.now(),
      name: name,
      rations: [{id: Date.now(), name: "Standard", lbs: new Array(data.feeds.length).fill(0)}]
    });
    save();
    document.getElementById('newGroupName').value = '';
    renderGroups();
    renderCalc();
  }

  function updateGroupName(id, name) { data.groups.find(g => g.id == id).name = name; save(); renderCalc(); }
  function deleteGroup(id) { if(confirm("Delete entire group?")) { data.groups = data.groups.filter(g => g.id != id); save(); renderGroups(); renderCalc(); } }

  function updateRationName(gid, rid, name) {
    const ration = data.groups.find(g => g.id == gid).rations.find(r => r.id == rid);
    ration.name = name; save(); renderCalc();
  }
  function deleteRation(gid, rid) {
    if(confirm("Delete this ration?")) {
      const group = data.groups.find(g => g.id == gid);
      group.rations = group.rations.filter(r => r.id != rid);
      save(); renderGroups(); renderCalc();
    }
  }
  function selectGroupAndAddRation(gid) {
    document.getElementById('groupSelect').value = gid;
    renderCalc();
    openTab('calc');
    setTimeout(addRation, 200);
  }

  // === INGREDIENTS TAB ===
  function renderFeeds() {
    document.getElementById('feedList').innerHTML = data.feeds.map(f => `
      <div class="row">
        <input value="${f.name}" onchange="updateFeedName(${f.id}, this.value)">
        <button class="del" onclick="deleteFeed(${f.id})">Delete</button>
      </div>
    `).join('');
  }

  function addFeed() {
    const name = document.getElementById('newFeedName').value.trim();
    if (!name) return alert("Enter ingredient name");
    data.feeds.push({id: Date.now(), name: name});
    data.groups.forEach(g => g.rations.forEach(r => r.lbs.push(0)));
    save();
    document.getElementById('newFeedName').value = '';
    renderFeeds();
    renderCalc();
  }

  function updateFeedName(id, name) {
    data.feeds.find(f => f.id == id).name = name;
    save();
    renderCalc();
  }

  function deleteFeed(id) {
    if (!confirm("Delete this ingredient from ALL rations?")) return;
    const idx = data.feeds.findIndex(f => f.id == id);
    data.feeds.splice(idx, 1);
    data.groups.forEach(g => g.rations.forEach(r => r.lbs.splice(idx, 1)));
    save();
    renderFeeds();
    renderCalc();
  }

  // Start
  openTab('calc');
</script>
</body>
</html>