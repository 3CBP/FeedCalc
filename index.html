<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PEDEN DAIRY FEEDCALC</title>
  <style>
    :root { --blue: #1565c0; --dark: #0d47a1; --accent: #ff9800; --red: #d32f2f; --green: #4caf50; }
    body { font-family: -apple-system, sans-serif; background: var(--blue); color: white; margin: 0; padding: 0; }
    header { background: var(--dark); padding: 25px; text-align: center; font-size: 32px; font-weight: 900; letter-spacing: 2px; }
    .tabs { display: flex; background: #1976d2; }
    .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: bold; font-size: 18px; }
    .tab.active { background: white; color: var(--dark); border-bottom: 5px solid var(--accent); }
    .content { padding: 20px; display: none; }
    .content.active { display: block; }
    input, select { width: 100%; padding: 16px; margin: 12px 0; border: none; border-radius: 10px; font-size: 18px; background: rgba(255,255,255,0.95); color: #000; }
    button { width: 100%; padding: 18px; margin: 15px 0; border: none; border-radius: 10px; font-size: 22px; font-weight: 900; cursor: pointer; }
    .calc { background: var(--accent); color: black; }
    .add { background: var(--green); color: white; }
    .del { background: var(--red); color: white; font-size: 16px; padding: 12px; width: auto; }
    .row { display: flex; align-items: center; gap: 15px; margin: 15px 0; background: rgba(255,255,255,0.12); padding: 15px; border-radius: 12px; }
    .row span { flex: 1; font-weight: bold; font-size: 18px; }
    .row input { width: 110px; text-align: center; font-size: 18px; }
    /* FEED SHEET - HUGE & LOADER-FRIENDLY */
    .feedsheet {
      background: white; color: black; padding: 30px; border-radius: 16px; margin: 30px 0;
      font-family: 'Courier New', monospace; font-size: 28px; font-weight: 900; line-height: 1.8;
      border: 6px solid var(--accent); box-shadow: 0 15px 40px rgba(0,0,0,0.6);
    }
    .feedsheet h2 { margin: 0 0 20px 0; color: var(--dark); font-size: 36px; text-align: center; }
    .loadline { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 3px dashed #666; }
    .cumulative { font-size: 32px; color: var(--green); text-align: right; margin: 20px 0; }
    .totals { background: #f0f0f0; padding: 20px; border-radius: 12px; margin-top: 30px; font-size: 30px; }
    .big { font-size: 40px; color: var(--accent); }
  </style>
</head>
<body>
  <header>PEDEN DAIRY FEED CALC</header>
  
  <div class="tabs">
    <div class="tab active" onclick="tab('calc')">Calculator</div>
    <div class="tab" onclick="tab('groups')">Groups</div>
    <div class="tab" onclick="tab('feeds')">Ingredients</div>
  </div>

  <div id="calc" class="content active">
    <select id="groupSelect"></select>
    <select id="rationSelect"></select>
    <button class="add" onclick="addRationToGroup()">+ New Ration</button>
    <input type="number" id="cows" placeholder="Number of cows" value="100">
    <div style="display:flex;gap:20px;justify-content:center;font-size:18px">
      <label><input type="radio" name="mode" value="percow" checked> Per cow</label>
      <label><input type="radio" name="mode" value="total"> Total herd</label>
    </div>
    <div id="inputs"></div>
    <button class="calc" onclick="calc()">GENERATE FEED SHEET</button>
    <div id="result"></div>
  </div>

  <div id="groups" class="content">
    <input type="text" id="newgroup" placeholder="New group name">
    <button class="add" onclick="addGroup()">Add Group</button>
    <div id="grouplist"></div>
  </div>

  <div id="feeds" class="content">
    <button class="add" onclick="addFeed()">+ Add Ingredient</button>
    <div id="feedlist"></div>
  </div>

  <script>
    let data = {groups: [], feeds: []};
    const defaults = {
      feeds: [
        {id:1,name:"Corn Silage",dm:35,nel:0.74,cp:8.5,ndf:42,price:48},
        {id:2,name:"Alfalfa Haylage",dm:40,nel:0.68,cp:20,ndf:44,price:180},
        {id:3,name:"Dairy Pellet",dm:89,nel:0.84,cp:19,ndf:22,price:340},
        {id:4,name:"Distillers Wet",dm:32,nel:0.92,cp:30,ndf:38,price:135},
        {id:5,name:"Cottonseed",dm:92,nel:0.98,cp:24,ndf:50,price:380}
      ],
      groups: [
        {id:1,name:"High Group",rations: [
          {id:1,name:"Summer TMR",lbs:[24,12,8,6,2]},
          {id:2,name:"Winter TMR",lbs:[20,15,10,5,1]}
        ]},
        {id:2,name:"Fresh Cows",rations: [
          {id:3,name:"Day 1-21",lbs:[18,14,12,8,3]}
        ]}
      ]
    };

    try { data = JSON.parse(localStorage.dairyDB||"{}"); } catch(e) {}
    if (!data.feeds?.length) data = JSON.parse(JSON.stringify(defaults));

    function save() { localStorage.dairyDB = JSON.stringify(data); }

    function tab(t) {
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.content').forEach(x=>x.classList.remove('active'));
      document.querySelector(`[onclick="tab('${t}')"]`).classList.add('active');
      document.getElementById(t).classList.add('active');
      if(t==='calc') renderCalc();
      if(t==='groups') renderGroups();
      if(t==='feeds') renderFeeds();
    }

    function renderCalc() {
      document.getElementById('groupSelect').innerHTML = data.groups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
      updateRationSelect();
      updateInputs();
    }

    function updateRationSelect() {
      const gid = document.getElementById('groupSelect').value;
      const group = data.groups.find(g=>g.id==gid);
      document.getElementById('rationSelect').innerHTML = group.rations.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
    }

    function updateInputs() {
      const gid = document.getElementById('groupSelect').value;
      const rid = document.getElementById('rationSelect').value;
      const group = data.groups.find(g=>g.id==gid);
      const ration = group.rations.find(r=>r.id==rid);
      let html = '';
      data.feeds.forEach((f,i) => {
        html += `<div class="row">
          <span>${f.name}</span>
          <input type="number" id="lb${i}" value="${ration.lbs[i]||0}" step="0.1">
          <span>lb</span>
        </div>`;
      });
      document.getElementById('inputs').innerHTML = html;
    }

    function addRationToGroup() {
      const name = prompt("Ration name:");
      if(!name) return;
      const gid = document.getElementById('groupSelect').value;
      const group = data.groups.find(g=>g.id==gid);
      group.rations.push({id:Date.now(),name,lbs:new Array(data.feeds.length).fill(0)});
      save();
      updateRationSelect();
      document.getElementById('rationSelect').value = group.rations[group.rations.length-1].id;
      updateInputs();
    }

    function calc() {
      const gid = document.getElementById('groupSelect').value;
      const rid = document.getElementById('rationSelect').value;
      const cows = parseFloat(document.getElementById('cows').value)||1;
      const perCow = document.querySelector('input[name="mode"]:checked').value === 'percow';
      const group = data.groups.find(g=>g.id==gid);
      const ration = group.rations.find(r=>r.id==rid);

      // Save current lbs
      data.feeds.forEach((f,i) => ration.lbs[i] = parseFloat(document.getElementById(`lb${i}`).value)||0);
      save();

      const multiplier = perCow ? 1 : (1/cows);
      const totalAsFed = ration.lbs.reduce((a,b)=>a+b,0) / multiplier;

      if (totalAsFed === 0) {
        document.getElementById('result').innerHTML = '<div class="feedsheet"><h2>NO INGREDIENTS!</h2></div>';
        return;
      }

      let cumulative = 0;
      let dmTotal = 0, nelW = 0, cpW = 0, ndfW = 0, costW = 0;
      let loadLines = '';

      // Sort by ingredient name for consistent loading order
      const sorted = data.feeds.map((f,i) => ({f, i, lb: ration.lbs[i]}))
        .filter(x => x.lb > 0)
        .sort((a,b) => a.f.name.localeCompare(b.f.name));

      sorted.forEach(item => {
        const lb = item.lb / multiplier;
        cumulative += lb;
        const pct = (lb / totalAsFed) * 100;
        const dmLb = lb * (item.f.dm/100);
        loadLines += `<div class="loadline">
          <div><strong>${item.f.name}</strong></div>
          <div><span class="big">${lb.toFixed(0)}</span> lb</div>
        </div>
        <div class="cumulative">CUMULATIVE: ${cumulative.toFixed(0)} lb</div>`;

        dmTotal += dmLb;
        nelW += dmLb * item.f.nel;
        cpW += dmLb * (item.f.cp/100);
        ndfW += dmLb * (item.f.ndf/100);
        costW += lb * (item.f.price/2000);
      });

      const nel = nelW / dmTotal;
      const cp = (cpW / dmTotal) * 100;
      const ndf = (ndfW / dmTotal) * 100;
      const dmi = dmTotal / (perCow ? 1 : cows);

      const sheet = `
      <div class="feedsheet">
        <h2>FEED SHEET - ${group.name}<br>${ration.name}</h2>
        <div style="text-align:center;margin:20px 0;font-size:32px">
          ${perCow ? '1 COW' : cows + ' COWS'} × ${dmi.toFixed(1)} lb DM
        </div>
        ${loadLines}
        <div class="totals">
          <div>TOTAL BATCH: <span class="big">${totalAsFed.toFixed(0)}</span> lb as-fed</div>
          <div>NEₗ: ${nel.toFixed(3)} Mcal/lb</div>
          <div>CP: ${cp.toFixed(1)}% | NDF: ${ndf.toFixed(1)}%</div>
          <div>COST: <span class="big">$${costW.toFixed(0)}</span> / ${perCow?'cow/day':'herd/day'}</div>
        </div>
      </div>`;

      document.getElementById('result').innerHTML = sheet;
    }

    function renderGroups() {
      let html = '';
      data.groups.forEach(g => {
        html += `<div style="margin:20px 0;background:rgba(255,255,255,0.1);padding:15px;border-radius:12px">
          <div class="row"><input value="${g.name}" onchange="renameGroup(${g.id},this.value)">
            <button class="del" onclick="delGroup(${g.id})">Delete Group</button>
          </div>
          ${g.rations.map(r=>`
            <div class="row" style="margin-left:20px;">
              <input value="${r.name}" onchange="renameRation(${g.id},${r.id},this.value)">
              <button class="del" onclick="delRation(${g.id},${r.id})">Delete</button>
            </div>
          `).join('')}
        </div>`;
      });
      document.getElementById('grouplist').innerHTML = html;
    }

    function renameGroup(id,val){ data.groups.find(g=>g.id==id).name=val; save(); renderCalc(); }
    function renameRation(gid,rid,val){ data.groups.find(g=>g.id==gid).rations.find(r=>r.id==rid).name=val; save(); renderCalc(); }
    function delGroup(id){ if(confirm('Delete entire group?')){ data.groups=data.groups.filter(g=>g.id!=id); save(); renderGroups(); renderCalc(); } }
    function delRation(gid,rid){ if(confirm('Delete ration?')){ data.groups.find(g=>g.id==gid).rations=data.groups.find(g=>g.id==gid).rations.filter(r=>r.id!=rid); save(); renderGroups(); renderCalc(); } }

    function addGroup() {
      const name = prompt("Group name:") || "New Group";
      data.groups.push({id:Date.now(),name,rations:[]});
      save(); renderGroups(); renderCalc();
    }

    function renderFeeds() {
      document.getElementById('feedlist').innerHTML = data.feeds.map(f=>`
        <div style="background:rgba(255,255,255,0.12);padding:18px;margin:15px 0;border-radius:14px">
          <input value="${f.name}" onchange="edit(${f.id},'name',this.value)" style="font-size:20px;font-weight:bold">
          <div class="row"><input type="number" value="${f.dm}" step="0.1" onchange="edit(${f.id},'dm',this.value)"> DM%</div>
          <div class="row"><input type="number" value="${f.nel}" step="0.001" onchange="edit(${f.id},'nel',this.value)"> NEₗ</div>
          <div class="row"><input type="number" value="${f.cp}" step="0.1" onchange="edit(${f.id},'cp',this.value)"> CP%</div>
          <div class="row"><input type="number" value="${f.ndf}" step="0.1" onchange="edit(${f.id},'ndf',this.value)"> NDF%</div>
          <div class="row"><input type="number" value="${f.price}" step="1" onchange="edit(${f.id},'price',this.value)"> $/ton</div>
          <button class="del" onclick="delFeed(${f.id})">Delete</button>
        </div>`).join('');
    }

    function edit(id,fld,val) {
      const feed = data.feeds.find(x=>x.id==id);
      feed[fld] = fld==='name'?val:parseFloat(val)||0;
      save();
    }

    function addFeed() {
      const n = prompt("Ingredient name:");
      if(n){ data.feeds.push({id:Date.now(),name:n,dm:88,nel:0.80,cp:18,ndf:25,price:300});
      data.groups.forEach(g=>g.rations.forEach(r=>r.lbs.push(0))); save(); renderFeeds(); renderCalc(); }
    }

    function delFeed(id) {
      if(confirm('Delete from ALL groups & rations?')){
        const i = data.feeds.findIndex(x=>x.id==id);
        data.feeds.splice(i,1);
        data.groups.forEach(g=>g.rations.forEach(r=>r.lbs.splice(i,1)));
        save(); renderFeeds(); renderCalc();
      }
    }

    document.getElementById('groupSelect').onchange = () => { updateRationSelect(); updateInputs(); };
    document.getElementById('rationSelect').onchange = updateInputs;
    document.querySelectorAll('input[name="mode"]').forEach(r=>r.onchange=updateInputs);
    renderCalc();
  </script>
</body>
</html>