<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ULTIMATE DAIRY TMR PRO</title>
  <style>
    :root { --blue:#1565c0; --dark:#0d47a1; --accent:#ff9800; --red:#d32f2f; --green:#4caf50; }
    body {font-family:-apple-system,sans-serif;background:var(--blue);color:white;margin:0;padding:0;transition:0.3s}
    body.dark {background:#000;color:#fff}
    header {background:var(--dark);padding:20px;text-align:center;font-size:28px;font-weight:900}
    .tabs {display:flex;background:#1976d2;position:sticky;top:0;z-index:100}
    .tab {flex:1;padding:16px;text-align:center;cursor:pointer;font-weight:bold}
    .tab.active {background:white;color:var(--dark);border-bottom:5px solid var(--accent)}
    .content {padding:20px;display:none}
    .content.active {display:block}
    input,select,button {width:100%;padding:14px;margin:10px 0;border:none;border-radius:8px;font-size:17px}
    button {font-weight:900;cursor:pointer}
    .calc {background:var(--accent);color:black}
    .add {background:var(--green)}
    .del {background:var(--red);font-size:14px;padding:10px;width:auto}
    .print {background:#2196f3}
    .darkbtn {background:#333}
    .row {display:flex;gap:12px;align-items:center;margin:12px 0;background:rgba(255,255,255,0.1);padding:12px;border-radius:8px}
    .row span {flex:1;font-weight:bold}
    .row input[type=number] {width:110px;text-align:center}
    .feedsheet {background:white;color:black;padding:30px;border-radius:16px;margin:30px 0;border:6px solid var(--accent);box-shadow:0 15px 40px rgba(0,0,0,0.6)}
    .feedsheet h2 {margin:0 0 20px;color:var(--dark);font-size:36px;text-align:center}
    .loadline {display:flex;justify-content:space-between;padding:15px 0;border-bottom:3px dashed #666;font-size:32px;font-weight:900}
    .cumulative {font-size:36px;color:var(--green);text-align:right;margin:20px 0;font-weight:900}
    .totals {background:#f0f0f0;padding:25px;border-radius:12px;margin-top:30px;font-size:28px;font-weight:bold}
    .big {font-size:48px;color:var(--accent)}
    .ready {background:#d32f2f;color:white;padding:20px;font-size:32px;text-align:center;border-radius:12px;animation:flash 1s infinite}
    .qr {text-align:center;margin:20px 0}
    @keyframes flash {0%,100%{opacity:1}50%{opacity:0.7}}
    @media print {body{background:white;color:black}.no-print{display:none}.feedsheet{border:none;box-shadow:none}}
  </style>
</head>
<body>
  <header>ULTIMATE DAIRY TMR PRO</header>
  
  <div class="tabs no-print">
    <div class="tab active" onclick="tab('calc')">Calculator</div>
    <div class="tab" onclick="tab('groups')">Groups</div>
    <div class="tab" onclick="tab('feeds')">Ingredients</div>
    <div class="tab" onclick="tab('settings')">Settings</div>
  </div>

  <div id="calc" class="content active">
    <select id="groupSelect"></select>
    <select id="rationSelect"></select>
    <button class="add" onclick="addRation()">+ New Ration</button>
    <input type="number" id="cows" placeholder="Cows" value="100">
    <input type="number" id="batches" placeholder="Batches today" value="1">
    <div style="display:flex;gap:20px;justify-content:center">
      <label><input type="radio" name="mode" value="percow" checked> Per cow</label>
      <label><input type="radio" name="mode" value="total"> Total herd</label>
    </div>
    <div id="inputs"></div>
    <button class="calc" onclick="calc()">GENERATE FEED SHEET</button>
    <button class="print" onclick="window.print()">PRINT</button>
    <button class="darkbtn" onclick="document.body.classList.toggle('dark')">DARK MODE</button>
    <div id="result"></div>
  </div>

  <div id="groups" class="content">
    <input type="text" id="newgroup" placeholder="New group name">
    <button class="add" onclick="addGroup()">Add Group</button>
    <div id="grouplist"></div>
  </div>

  <div id="feeds" class="content">
    <button class="add" onclick="addFeed()">+ Add Ingredient</button>
    <div style="margin:20px 0">Drag to set load order:</div>
    <div id="feedlist" style="min-height:50px"></div>
  </div>

  <div id="settings" class="content">
    <h3>Settings</h3>
    <button class="del" onclick="if(confirm('Delete ALL data?')){localStorage.clear();location.reload()}">RESET EVERYTHING</button>
    <p>Batches today: <span id="batchCount">0</span></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/lib/qrcode.min.js"></script>
  <script>
    let data = {groups:[],feeds:[],settings:{batchCount:0}};
    const defaults = {
      feeds:[
        {id:1,name:"Corn Silage",dm:35,nel:0.74,cp:8.5,ndf:42,price:48},
        {id:2,name:"Alfalfa Haylage",dm:40,nel:0.68,cp:20,ndf:44,price:180},
        {id:3,name:"Dairy Pellet",dm:89,nel:0.84,cp:19,ndf:22,price:340},
        {id:4,name:"Distillers Wet",dm:32,nel:0.92,cp:30,ndf:38,price:135},
        {id:5,name:"Cottonseed",dm:92,nel:0.98,cp:24,ndf:50,price:380}
      ],
      groups:[
        {id:1,name:"High Group",rations:[
          {id:1,name:"Summer TMR",lbs:[24,12,8,6,2]},
          {id:2,name:"Winter TMR",lbs:[20,15,10,5,1]}
        ]},
        {id:2,name:"Fresh Cows",rations:[
          {id:3,name:"Day 1-21",lbs:[18,14,12,8,3]}
        ]}
      ]
    };

    try {data=JSON.parse(localStorage.getItem('dairyTMR')||JSON.stringify(defaults))} catch(e){data=defaults}
    function save(){localStorage.setItem('dairyTMR',JSON.stringify(data))}

    function tab(t){
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.content').forEach(x=>x.classList.remove('active'));
      document.querySelector(`[onclick="tab('${t}')"]`).classList.add('active');
      document.getElementById(t).classList.add('active');
      if(t==='calc')renderCalc();
      if(t==='groups')renderGroups();
      if(t==='feeds')renderFeeds();
      if(t==='settings')document.getElementById('batchCount').innerText=data.settings.batchCount;
    }

    function renderCalc(){
      document.getElementById('groupSelect').innerHTML=data.groups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
      updateRationSelect(); updateInputs();
    }
    function updateRationSelect(){
      const gid=document.getElementById('groupSelect').value;
      const group=data.groups.find(g=>g.id==gid);
      document.getElementById('rationSelect').innerHTML=group.rations.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
    }
    function updateInputs(){
      const gid=document.getElementById('groupSelect').value;
      const rid=document.getElementById('rationSelect').value;
      const ration=data.groups.find(g=>g.id==gid).rations.find(r=>r.id==rid);
      let html='';
      data.feeds.forEach((f,i)=>{
        html+=`<div class="row">
          <span>${f.name}</span>
          <input type="number" id="lb${i}" value="${ration.lbs[i]||0}" step="0.1">
          <span>lb</span>
        </div>`;
      });
      document.getElementById('inputs').innerHTML=html;
    }

    function addRation(){
      const name=prompt("Ration name:"); if(!name)return;
      const gid=document.getElementById('groupSelect').value;
      const group=data.groups.find(g=>g.id==gid);
      group.rations.push({id:Date.now(),name,lbs:new Array(data.feeds.length).fill(0)});
      save(); updateRationSelect(); document.getElementById('rationSelect').value=group.rations[group.rations.length-1].id; updateInputs();
    }

    function calc(){
      const gid=document.getElementById('groupSelect').value;
      const rid=document.getElementById('rationSelect').value;
      const cows=parseFloat(document.getElementById('cows').value)||1;
      const batches=parseFloat(document.getElementById('batches').value)||1;
      const perCow=document.querySelector('input[name="mode"]:checked').value==='percow';
      const group=data.groups.find(g=>g.id==gid);
      const ration=group.rations.find(r=>r.id==rid);

      data.feeds.forEach((f,i)=>ration.lbs[i]=parseFloat(document.getElementById(`lb${i}`).value)||0);
      save();

      data.settings.batchCount++;
      save();
      document.getElementById('batchCount').innerText=data.settings.batchCount;

      let totalAsFed=0, dmTotal=0, nelW=0, cpW=0, ndfW=0, costW=0;
      let loadLines='', cumulative=0;

      const sorted=data.feeds.map((f,i)=>({f,i,lb:ration.lbs[i]*batches*(perCow?1:cows)}))
        .filter(x=>x.lb>0)
        .sort((a,b)=>a.f.name.localeCompare(b.f.name));

      sorted.forEach(item=>{
        const lb=item.lb;
        cumulative+=lb;
        const pct=(lb/(cumulative))*100;
        const dmLb=lb*(item.f.dm/100);
        loadLines+=`<div class="loadline">
          <div><strong>${item.f.name}</strong></div>
          <div><span class="big">${lb.toFixed(0)}</span> lb</div>
        </div>
        <div class="cumulative">CUMULATIVE: ${cumulative.toFixed(0)} lb</div>`;

        dmTotal+=dmLb;
        nelW+=dmLb*item.f.nel;
        cpW+=dmLb*(item.f.cp/100);
        ndfW+=dmLb*(item.f.ndf/100);
        costW+=lb*(item.f.price/2000);
      });

      const nel=nelW/dmTotal;
      const cp=(cpW/dmTotal)*100;
      const ndf=(ndfW/dmTotal)*100;
      const dmi=dmTotal/(perCow?1:cows)/batches;

      const qrDiv=document.createElement('div');
      new QRCode(qrDiv,{text:location.href,width:200,height:200});

      document.getElementById('result').innerHTML=`
        <div class="ready">BATCH #${data.settings.batchCount} READY!</div>
        <div class="feedsheet">
          <h2>${group.name} - ${ration.name}</h2>
          <div style="text-align:center;font-size:32px">
            ${perCow?'1 COW':'TOTAL HERD'} × ${batches} BATCH${batches>1?'ES':''} = ${cows*batches} COWS<br>
            DM: ${dmi.toFixed(1)} lb/cow
          </div>
          ${loadLines}
          <div class="totals">
            <div>TOTAL BATCH: <span class="big">${cumulative.toFixed(0)}</span> lb</div>
            <div>NEₗ ${nel.toFixed(3)} | CP ${cp.toFixed(1)}% | NDF ${ndf.toFixed(1)}%</div>
            <div>COST $<span class="big">${costW.toFixed(0)}</span> (${(costW/(cows*batches)).toFixed(2)}/cow)</div>
          </div>
          <div class="qr">${qrDiv.innerHTML}</div>
        </div>`;
    }

    function renderGroups(){
      let html='';
      data.groups.forEach(g=>{
        html+=`<div style="margin:20px 0;background:rgba(255,255,255,0.1);padding:15px;border-radius:12px">
          <div class="row"><input value="${g.name}" onchange="renameGroup(${g.id},this.value)">
            <button class="del" onclick="delGroup(${g.id})">Delete Group</button>
          </div>
          ${g.rations.map(r=>`
            <div class="row" style="margin-left:20px">
              <input value="${r.name}" onchange="renameRation(${g.id},${r.id},this.value)">
              <button class="del" onclick="delRation(${g.id},${r.id})">Delete</button>
            </div>`).join('')}
        </div>`;
      });
      document.getElementById('grouplist').innerHTML=html;
    }

    function renameGroup(id,v){data.groups.find(g=>g.id==id).name=v;save();renderCalc()}
    function renameRation(gid,rid,v){data.groups.find(g=>g.id==gid).rations.find(r=>r.id==rid).name=v;save();renderCalc()}
    function delGroup(id){if(confirm('Delete group?')){data.groups=data.groups.filter(g=>g.id!=id);save();renderGroups();renderCalc()}}
    function delRation(gid,rid){if(confirm('Delete ration?')){data.groups.find(g=>g.id==gid).rations=data.groups.find(g=>g.id==gid).rations.filter(r=>r.id!=rid);save();renderGroups();renderCalc()}}

    function addGroup(){
      const name=prompt("Group name:")||"New Group";
      data.groups.push({id:Date.now(),name,rations:[]});
      save(); renderGroups(); renderCalc();
    }

    function renderFeeds(){
      const list=document.getElementById('feedlist');
      list.innerHTML=data.feeds.map(f=>`
        <div class="row" data-id="${f.id}" style="cursor:move">
          <input value="${f.name}" onchange="edit(${f.id},'name',this.value)" style="font-weight:bold">
          <input type="number" value="${f.dm}" step="0.1" onchange="edit(${f.id},'dm',this.value)"> DM%
          <input type="number" value="${f.nel}" step="0.001" onchange="edit(${f.id},'nel',this.value)"> NEₗ
          <input type="number" value="${f.cp}" step="0.1" onchange="edit(${f.id},'cp',this.value)"> CP%
          <input type="number" value="${f.ndf}" step="0.1" onchange="edit(${f.id},'ndf',this.value)"> NDF%
          <input type="number" value="${f.price}" step="1" onchange="edit(${f.id},'price',this.value)"> $/ton
          <button class="del" onclick="delFeed(${f.id})">Delete</button>
        </div>`).join('');
      new Sortable(list,{animation:150,onEnd:()=>{data.feeds=Array.from(list.children).map(el=>data.feeds.find(f=>f.id==el.dataset.id));save()}});
    }

    function edit(id,fld,val){
      const f=data.feeds.find(x=>x.id==id);
      f[fld]=fld==='name'?val:parseFloat(val)||0;
      save();
    }

    function addFeed(){
      const name=prompt("Ingredient name:");
      if(name){
        data.feeds.push({id:Date.now(),name,dm:88,nel:0.80,cp:18,ndf:25,price:300});
        data.groups.forEach(g=>g.rations.forEach(r=>r.lbs.push(0)));
        save(); renderFeeds(); renderCalc();
      }
    }

    function delFeed(id){
      if(confirm('Delete from ALL rations?')){
        const i=data.feeds.findIndex(x=>x.id==id);
        data.feeds.splice(i,1);
        data.groups.forEach(g=>g.rations.forEach(r=>r.lbs.splice(i,1)));
        save(); renderFeeds(); renderCalc();
      }
    }

    document.getElementById('groupSelect').onchange=()=>{updateRationSelect();updateInputs()};
    document.getElementById('rationSelect').onchange=updateInputs;
    document.querySelectorAll('input[name="mode"]').forEach(r=>r.onchange=updateInputs);
    renderCalc();
  </script>
</body>
</html>